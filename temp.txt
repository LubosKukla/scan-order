<template>
  <section class="space-y-8">
    <AdminPageHeader
      title="Recenzie"
      subtitle="Pozrite si, čo si vaši zákazníci myslia o vašej reštaurácii a jedlách."
    />

    <div class="space-y-6 bg-ink border-transparent">
      <div class="flex flex-wrap gap-3">
        <button
          v-for="tab in tabs"
          :key="tab.key"
          type="button"
          class="rounded-full px-5 py-2 text-sm font-semibold transition cursor-pointer"
          :class="tabClass(tab.key)"
          @click="activeTab = tab.key"
        >
          {{ tab.label }}
        </button>
      </div>

      <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
        <div v-for="card in statCards" :key="card.key" class="flex flex-col gap-3">
          <BaseCard>
            <div class="flex items-center justify-between gap-4">
              <div class="flex flex-col items-start justify-between gap-1">
                <p class="text-xs font-semibold text-left text-deep">{{ card.label }}</p>
                <div class="space-y-1 f">
                  <p v-if="card.key !== 'averageRating'" class="text-md font-semibold text-deep">{{ card.value }}</p>
                  <ReviewRatingDisplay v-if="card.key === 'averageRating'" :rating="averageRating" :show-value="true" />
                </div>
              </div>
              <span class="rounded-xl bg-ink/60 p-3 text-primary">
                <font-awesome-icon :icon="card.icon" class="h-5 w-5" />
              </span>
            </div>
          </BaseCard>
        </div>
      </div>
    </div>

    <BaseCard class="space-y-4">
      <div class="grid gap-2 md:grid-cols-[2fr_1fr_1fr]">
        <BaseInput v-model="filters.search" type="search" placeholder="Hľadať podľa mena, jedla alebo textu..." />
        <BaseSelect v-model="filters.rating" :options="ratingOptions" placeholder="Všetky hodnotenia" />
        <BaseSelect v-model="filters.period" :options="monthOptions" placeholder="Všetky mesiace" />
      </div>
    </BaseCard>

    <BaseCard class="space-y-4">
      <div>
        <p class="text-lg font-semibold text-deep">Zoznam recenzií</p>
        <p class="text-sm text-deep">Zobrazuje sa {{ filteredReviews.length }} z {{ reviews.length }} recenzií</p>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-ink/20 text-sm">
          <thead>
            <tr class="text-left text-xs font-semibold uppercase text-deep/60">
              <th class="px-4 py-3">Typ</th>
              <th class="px-4 py-3">Recenzent</th>
              <th class="px-4 py-3">Hodnotenie</th>
              <th class="px-4 py-3">Komentár</th>
              <th class="px-4 py-3">Dátum</th>
              <th class="px-4 py-3">Zdroj</th>
              <th class="px-4 py-3 text-right">Akcie</th>
            </tr>
          </thead>
          <tbody>
            <tr
              v-for="review in filteredReviews"
              :key="review.id"
              class="text-deep hover:bg-ink/30 border-x border-x-white hover:border-x hover:border-x-ink/80 border-t border-t-ink"
            >
              <td class="padding-item">
                <ReviewTypeBadge :type="review.type" />
              </td>
              <td class="padding-item font-semibold">
                {{ review.reviewer }}
              </td>
              <td class="padding-item">
                <ReviewRatingDisplay :rating="review.rating" />
              </td>
              <td class="padding-item">
                <p>{{ review.comment }}</p>
                <p v-if="review.dishDescription" class="text-xs text-deep/60">{{ review.dishDescription }}</p>
              </td>
              <td class="padding-item text-deep/70">
                {{ formatDate(review.date) }}
              </td>
              <td class="padding-item">
                <ReviewSourceTag :type="review.sourceType" :label="review.sourceLabel" />
              </td>
              <td class="padding-item text-right">
                <div class="flex items-center justify-end gap-2">
                  <BaseButton variant="noBackground" icon="view" class="text-deep/70 hover:text-primary" />
                  <BaseButton variant="noBackground" icon="reply" class="text-deep/70 hover:text-primary" />
                  <BaseButton variant="noBackground" icon="trash" class="text-danger hover:text-danger" />
                </div>
              </td>
            </tr>
            <tr v-if="!filteredReviews.length">
              <td colspan="7" class="px-4 py-8 text-center text-sm text-deep">Žiadne recenzie pre zvolené filtre.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </BaseCard>
  </section>
</template>

<script>
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome';
import { faStar, faCommentDots, faCalendarCheck, faChartLine } from '@fortawesome/free-solid-svg-icons';
import BaseCard from '@/components/global/containers/BaseCard.vue';
import BaseInput from '@/components/global/inputs/BaseInput.vue';
import BaseSelect from '@/components/global/inputs/BaseSelect.vue';
import BaseButton from '@/components/global/buttons/BaseButton.vue';
import BaseTextarea from '@/components/global/inputs/BaseTextarea.vue';
import BaseToggle from '@/components/global/inputs/BaseToggle.vue';
import BaseModal from '@/components/global/containers/BaseModal.vue';
import AdminPageHeader from '@/components/layout/funkcionality/AdminPageHeader.vue';
import ReviewTypeBadge from '@/components/global/feedback/ReviewTypeBadge.vue';
import ReviewRatingDisplay from '@/components/global/feedback/ReviewRatingDisplay.vue';
import ReviewSourceTag from '@/components/global/feedback/ReviewSourceTag.vue';

const SAMPLE_REVIEWS = [
  {
    id: 1,
    type: 'restaurant',
    reviewer: 'Jana Nováková',
    rating: 4.9,
    comment: 'Výborné jedlo, skvelá obsluha a príjemné prostredie. Určite sa vrátime!',
    date: '2025-11-01',
    sourceType: 'qr',
    sourceLabel: 'QR - Stôl 4',
    responded: true,
  },
  {
    id: 2,
    type: 'dish',
    reviewer: 'Peter Horváth',
    rating: 4.1,
    comment: 'Steak bol chutný, ale trochu tuhší ako som očakával. Inak super!',
    dishDescription: 'Jedlo: Hovädzí steak s omáčkou',
    date: '2025-11-02',
    sourceType: 'qr',
    sourceLabel: 'QR - Stôl 2',
    responded: false,
  },
  {
    id: 3,
    type: 'restaurant',
    reviewer: 'Anonymous',
    rating: 4.7,
    comment: 'Najlepšia reštaurácia v meste! Musíte vyskúšať ich gnocchi.',
    date: '2025-11-03',
    sourceType: 'online',
    sourceLabel: 'Online',
    responded: true,
  },
  {
    id: 4,
    type: 'dish',
    reviewer: 'Martina Kováčová',
    rating: 4.8,
    comment: 'Najlepšie gnocchi, aké som jedla! Perfektná konzistencia a chuť.',
    dishDescription: 'Jedlo: Gnocchi so špenátom',
    date: '2025-11-03',
    sourceType: 'qr',
    sourceLabel: 'QR - Terasa 1',
    responded: true,
  },
  {
    id: 5,
    type: 'restaurant',
    reviewer: 'Tomáš Lukáč',
    rating: 3.9,
    comment: 'Jedlo bolo dobré, ale čakali sme dosť dlho. Mohlo by to byť rýchlejšie.',
    date: '2025-10-28',
    sourceType: 'qr',
    sourceLabel: 'QR - Stôl 7',
    responded: false,
  },
  {
    id: 6,
    type: 'dish',
    reviewer: 'Eva Szabová',
    rating: 4.5,
    comment: 'Dezert bol absolútne fantastický! Určite si dám znova.',
    dishDescription: 'Jedlo: Tiramisu',
    date: '2025-10-29',
    sourceType: 'online',
    sourceLabel: 'Online',
    responded: false,
  },
];

const RATING_OPTIONS = [
  { label: 'Všetky hodnotenia', value: 'all' },
  { label: '5 hviezdičiek', value: '5' },
  { label: '4 hviezdičky a viac', value: '4' },
  { label: '3 hviezdičky a viac', value: '3' },
];

export default {
  name: 'AdminRecenzieView',
  components: {
    AdminPageHeader,
    BaseCard,
    BaseInput,
    BaseSelect,
    BaseButton,
    BaseTextarea,
    BaseToggle,
    BaseModal,
    ReviewTypeBadge,
    ReviewRatingDisplay,
    ReviewSourceTag,
    FontAwesomeIcon,
  },
  data() {
    return {
      tabs: [
        { key: 'all', label: 'Všetky' },
        { key: 'restaurant', label: 'Reštaurácia' },
        { key: 'dish', label: 'Jedlá' },
      ],
      activeTab: 'all',
      reviews: SAMPLE_REVIEWS,
      filters: {
        search: '',
        rating: 'all',
        period: 'all',
      },
      ratingOptions: RATING_OPTIONS,
      currentMonthKey: '2025-11',
      selectedReview: null,
      replyModalVisible: false,
      viewModalVisible: false,
      deleteModalVisible: false,
      replyForm: {
        message: '',
        public: true,
      },
    };
  },
  computed: {
    averageRating() {
      if (!this.reviews.length) return 0;
      const total = this.reviews.reduce((sum, review) => sum + review.rating, 0);
      return total / this.reviews.length;
    },
    totalReviews() {
      return this.reviews.length;
    },
    reviewsThisMonth() {
      return this.reviews.filter((review) => this.reviewPeriodKey(review) === this.currentMonthKey).length;
    },
    responseRate() {
      if (!this.reviews.length) return 0;
      const replied = this.reviews.filter((review) => review.responded).length;
      return Math.round((replied / this.reviews.length) * 100);
    },
    statCards() {
      return [
        { key: 'averageRating', label: 'Priemerné hodnotenie', value: this.averageRating.toFixed(1), icon: faStar },
        { key: 'total', label: 'Celkovo recenzií', value: this.totalReviews, icon: faCommentDots },
        { key: 'monthly', label: 'Tento mesiac', value: this.reviewsThisMonth, icon: faCalendarCheck },
        { key: 'response', label: 'Miera odpovedí', value: `${this.responseRate}%`, icon: faChartLine },
      ];
    },
    //generated by ai
    monthOptions() {
      const uniqueMonths = Array.from(new Set(this.reviews.map((review) => this.reviewPeriodKey(review)))).sort(
        (a, b) => (a < b ? 1 : -1)
      );
      const formatter = new Intl.DateTimeFormat('sk-SK', { month: 'long', year: 'numeric' });
      const formatted = uniqueMonths.map((value) => {
        const [year, month] = value.split('-');
        const date = new Date(Number(year), Number(month) - 1, 1);
        return {
          value,
          label: formatter.format(date),
        };
      });
      return [{ label: 'Všetky mesiace', value: 'all' }, ...formatted];
    },
    filteredReviews() {
      return this.reviews
        .filter((review) => (this.activeTab === 'all' ? true : review.type === this.activeTab))
        .filter((review) => {
          if (this.filters.rating === 'all') return true;
          if (this.filters.rating === '5') return Math.round(review.rating) === 5;
          if (this.filters.rating === '4') return review.rating >= 4;
          if (this.filters.rating === '3') return review.rating >= 3;
          return true;
        })
        .filter((review) => {
          if (this.filters.period === 'all') return true;
          return this.reviewPeriodKey(review) === this.filters.period;
        })
        .filter((review) => {
          const query = this.filters.search.trim().toLowerCase();
          if (!query) return true;
          return [review.reviewer, review.comment, review.dishDescription]
            .filter(Boolean)
            .some((value) => value.toLowerCase().includes(query));
        });
    },
  },
  methods: {
    tabClass(key) {
      return key === this.activeTab
        ? 'bg-white text-primary shadow-sm'
        : 'bg-white/40 text-deep/70 hover:bg-white hover:text-primary';
    },
    formatDate(dateValue) {
      if (!dateValue) return '';
      return new Intl.DateTimeFormat('sk-SK', {
        day: 'numeric',
        month: 'numeric',
        year: 'numeric',
      }).format(new Date(dateValue));
    },
    reviewPeriodKey(review) {
      const date = new Date(review.date);
      const month = String(date.getMonth() + 1).padStart(2, '0');
      return `${date.getFullYear()}-${month}`;
    },
  },
};
</script>

<style lang="scss" scoped>
.padding-item {
  padding: 0.7rem 0.5rem;
}
</style>
